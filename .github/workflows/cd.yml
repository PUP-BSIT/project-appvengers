name: I-Budget CD Deployment Workflow

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/ibudget/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 21
          cache: maven

      - name: Build Frontend
        working-directory: frontend/ibudget
        run: |
          npm ci
          npm run build --configuration=production

      - name: Verify PWA Build Artifacts
        working-directory: frontend/ibudget
        run: |
          echo "=== Checking PWA Build Artifacts ==="
          
          # Check for service worker
          if [ -f "dist/ibudget/browser/ngsw-worker.js" ]; then
            echo "âœ… ngsw-worker.js found"
          else
            echo "âŒ ngsw-worker.js missing"
            exit 1
          fi
          
          # Check for service worker config
          if [ -f "dist/ibudget/browser/ngsw.json" ]; then
            echo "âœ… ngsw.json found"
          else
            echo "âŒ ngsw.json missing"
            exit 1
          fi
          
          # Check for manifest
          if [ -f "dist/ibudget/browser/manifest.webmanifest" ]; then
            echo "âœ… manifest.webmanifest found"
          else
            echo "âŒ manifest.webmanifest missing"
            exit 1
          fi
          
          # Check for icons
          if [ -d "dist/ibudget/browser/icons" ]; then
            echo "âœ… icons directory found"
            ls -la dist/ibudget/browser/icons/
          else
            echo "âŒ icons directory missing"
            exit 1
          fi
          
          echo ""
          echo "=== PWA artifacts verified successfully! ==="

      - name: Build Backend
        working-directory: backend/appvengers
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Prepare prod branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Save build artifacts and deployment scripts to temp location
          mkdir -p /tmp/build-artifacts/frontend
          mkdir -p /tmp/build-artifacts/backend
          mkdir -p /tmp/build-artifacts/scripts
          mkdir -p /tmp/build-artifacts/config
          cp -r frontend/ibudget/dist/ibudget /tmp/build-artifacts/frontend/
          cp backend/appvengers/target/*.jar /tmp/build-artifacts/backend/ 2>/dev/null || true
          cp -r scripts/ /tmp/build-artifacts/
          cp ibudget-nginx.conf /tmp/build-artifacts/config/ 2>/dev/null || true
          
          # Create or checkout prod branch
          git fetch origin prod || true
          git checkout prod 2>/dev/null || git checkout --orphan prod
          
          # Clean prod branch (keep only build artifacts)
          git rm -rf . 2>/dev/null || true
          
          # Copy build artifacts and scripts from temp
          mkdir -p frontend/ibudget/dist
          mkdir -p backend/appvengers/target
          mkdir -p config
          cp -r /tmp/build-artifacts/frontend/ibudget frontend/ibudget/dist/
          cp /tmp/build-artifacts/backend/*.jar backend/appvengers/target/ 2>/dev/null || true
          cp -r /tmp/build-artifacts/scripts/ .
          cp /tmp/build-artifacts/config/ibudget-nginx.conf config/ 2>/dev/null || true
          
          # Add build artifacts and scripts
          git add -f frontend/ibudget/dist/
          git add -f backend/appvengers/target/*.jar
          git add -f scripts/
          git add -f config/ 2>/dev/null || true
          
          # Commit changes
          git commit -m "Deploy: Build from main branch $(git rev-parse --short main) at $(date -u +%Y-%m-%dT%H:%M:%SZ)" || echo "No changes to commit"
          
          # Push to prod branch
          git push origin prod --force

      - name: Deploy Environment File to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            # Create secure directory
            sudo mkdir -p /etc/ibudget
            sudo chmod 750 /etc/ibudget
            
            # Create environment file from GitHub Secrets
            sudo tee /etc/ibudget/backend.env > /dev/null << 'EOF'
            # iBudget Production Environment Variables
            # Auto-deployed by GitHub Actions CD Pipeline
            # Updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # Database Configuration
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            # JWT Configuration
            JWT_SECRET=${{ secrets.JWT_SECRET_PROD }}
            
            # Server Configuration
            SERVER_PORT=8081
            
            # Email Configuration
            MAIL_HOST=smtp.gmail.com
            MAIL_PORT=587
            MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
            MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
            
            # Application URLs
            APP_VERIFICATION_BASE=https://i-budget.site/api/auth/verify-email?token=
            PASSWORD_RESET_FRONTEND_URL=https://i-budget.site/reset-password?token=
            FRONTEND_URL=https://i-budget.site
            APP_EMAIL_FROM=${{ secrets.APP_EMAIL_FROM }}
            
            # N8N Webhook
            N8N_WEBHOOK_URL=${{ secrets.N8N_WEBHOOK_URL }}
            
            # Google OAuth2 Configuration
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            OAUTH2_REDIRECT_URI=https://i-budget.site/auth/callback
            EOF
            
            # Secure the file
            sudo chmod 640 /etc/ibudget/backend.env
            sudo chown root:root /etc/ibudget/backend.env
            
            echo "âœ“ Environment file deployed successfully"
            echo "Variables count: $(grep -c "^[^#]" /etc/ibudget/backend.env || echo 0)"

      - name: Copy Deployment Script to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "scripts/deploy.sh"
          target: "/var/www/ibudget/"
          overwrite: true

      - name: Set Script Permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            chmod +x /var/www/ibudget/scripts/deploy.sh

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            /var/www/ibudget/scripts/deploy.sh

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "=== Checking Service Status ==="
            systemctl is-active ibudget-backend nginx
            
            echo ""
            echo "=== Waiting for Spring Boot to start (30 seconds) ==="
            sleep 30
            
            echo ""
            echo "=== Backend Logs (last 30 lines) ==="
            journalctl -u ibudget-backend -n 30 --no-pager
            
            echo ""
            echo "=== Testing Frontend ==="
            FRONTEND_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://i-budget.site || echo "000")
            echo "Frontend Status: $FRONTEND_STATUS"
            
            echo ""
            echo "=== Testing Backend Health ==="
            BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/api/categories/all || echo "000")
            echo "Backend (localhost:8081) Status: $BACKEND_STATUS"
            
            echo ""
            echo "=== Testing API via Nginx ==="
            API_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://i-budget.site/api/categories/all || echo "000")
            echo "API (via Nginx) Status: $API_STATUS"
            
            echo ""
            echo "=== Testing PWA Assets ==="
            MANIFEST_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://i-budget.site/manifest.webmanifest || echo "000")
            echo "Manifest Status: $MANIFEST_STATUS"
            SW_STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://i-budget.site/ngsw-worker.js || echo "000")
            echo "Service Worker Status: $SW_STATUS"
            
            # Exit with error if critical services are down
            if [ "$BACKEND_STATUS" = "000" ]; then
              echo "ERROR: Backend is not responding"
              exit 1
            fi

      - name: Notify on Success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Frontend: https://i-budget.site"
          echo "Deployed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Rollback on Verification Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            echo "=========================================="
            echo "ðŸ”„ INITIATING AUTOMATIC ROLLBACK"
            echo "=========================================="
            
            BACKUP_DIR="/var/www/ibudget-backups"
            LATEST_BACKUP=$(ls -t "$BACKUP_DIR" | head -n 1)
            
            if [ -z "$LATEST_BACKUP" ]; then
              echo "âš ï¸ No backup found! Cannot rollback."
              echo "Manual intervention required on VPS"
              exit 1
            fi
            
            echo "Rolling back to: $LATEST_BACKUP"
            
            # Stop backend
            systemctl stop ibudget-backend
            
            # Restore backend JAR
            cd /var/www/ibudget
            if [ -f "$BACKUP_DIR/$LATEST_BACKUP"/*.jar ]; then
              cp "$BACKUP_DIR/$LATEST_BACKUP"/*.jar backend/appvengers/target/
              echo "âœ“ Backend JAR restored"
            else
              echo "âš ï¸ No backend JAR in backup"
            fi
            
            # Restore frontend
            if [ -d "$BACKUP_DIR/$LATEST_BACKUP/dist" ]; then
              rm -rf frontend/ibudget/dist
              cp -r "$BACKUP_DIR/$LATEST_BACKUP/dist" frontend/ibudget/
              echo "âœ“ Frontend restored"
            else
              echo "âš ï¸ No frontend build in backup"
            fi
            
            # Start backend
            systemctl start ibudget-backend
            sleep 5
            
            # Verify rollback
            if systemctl is-active --quiet ibudget-backend; then
              echo "âœ… Rollback successful! Backend is running."
            else
              echo "âŒ Rollback failed! Backend did not start."
              echo "CRITICAL: Manual intervention required immediately!"
              exit 1
            fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ðŸ”„ Automatic rollback has been attempted"
          echo "Check the logs above for rollback status"
          echo "If rollback succeeded, site should be back online with previous version"
          exit 1
