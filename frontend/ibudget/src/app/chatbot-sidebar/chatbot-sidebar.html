<div class="chatbot-sidebar" [class.open]="isOpen()">
    <div class="chatbot-header">
        <div class="header-content">
            <img src="assets/images/kamen-rider-gotchard.jpg" alt="Bonzi" class="header-avatar">
            <h3>Bonzi Buddy Chat</h3>
        </div>
        <div class="header-actions">
            @if (isTTSSupported()) {
            <button class="icon-btn" 
                    (click)="toggleSettings()" 
                    [class.active]="showSettings()"
                    title="Voice settings">
                <i class="bi bi-gear"></i>
            </button>
            <button class="icon-btn" 
                    (click)="toggleAutoSpeak()" 
                    [class.active]="autoSpeak()"
                    [title]="autoSpeak() ? 'Disable auto-read responses' : 'Enable auto-read responses'">
                <i class="bi" [ngClass]="autoSpeak() ? 'bi-volume-up-fill' : 'bi-volume-mute'"></i>
            </button>
            }
            <button class="icon-btn" (click)="clearChat()" title="Clear chat history">
                <i class="bi bi-trash"></i>
            </button>
            <button class="close-btn" (click)="toggleSidebar()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    @if (showSettings()) {
    <div class="settings-panel">
        <div class="settings-header">
            <i class="bi bi-volume-up"></i>
            <span>Voice Settings</span>
        </div>
        <div class="settings-content">
            <label class="settings-label">Select Voice</label>
            <select class="voice-select" 
                    [ngModel]="currentVoiceName()" 
                    (ngModelChange)="selectVoice($event)">
                @for (group of getGroupedVoices(); track group.lang) {
                <optgroup [label]="group.langName">
                    @for (voice of group.voices; track voice.name) {
                    <option [value]="voice.name">
                        {{ voice.name }}
                    </option>
                    }
                </optgroup>
                }
            </select>
            <button class="preview-btn" (click)="previewVoice()" [disabled]="isSpeaking()">
                <i class="bi" [ngClass]="isSpeaking() ? 'bi-stop-fill' : 'bi-play-fill'"></i>
                {{ isSpeaking() ? 'Stop' : 'Preview Voice' }}
            </button>
            <p class="settings-hint">
                <i class="bi bi-info-circle"></i>
                Choose a Philippine English voice for correct peso (â‚±) pronunciation.
            </p>
        </div>
    </div>
    }

    <div class="messages-container" #scrollContainer>
        @if (messages().length === 0) {
        <div class="empty-state">
            <i class="bi bi-stars"></i>
            <p>How can I help you today?</p>
        </div>
        }

        @for (msg of messages(); track msg.timestamp) {
        <div class="message-wrapper" [class.user]="msg.isUser" [class.bot]="!msg.isUser">
            @if (!msg.isUser) {
            <div class="bot-avatar">
                <img src="assets/images/kamen-rider-gotchard.jpg" alt="Bonzi">
            </div>
            }
            <div class="message" [class.user]="msg.isUser" [class.bot]="!msg.isUser">
                <div class="message-content" [innerHTML]="parseMarkdown(msg.text)"></div>
                
                @if (msg.action && !msg.isUser) {
                <div class="message-action">
                    <button class="action-btn" (click)="executeAction(msg.action)">
                        <i class="bi" [ngClass]="msg.action.icon || 'bi-arrow-right-circle'"></i>
                        <span>{{ msg.action.label || 'Take action' }}</span>
                        <i class="bi bi-chevron-right action-arrow"></i>
                    </button>
                </div>
                }
                
                <div class="message-footer">
                    <div class="message-time">
                        {{ msg.timestamp | date:'shortTime' }}
                    </div>
                    @if (!msg.isUser && isTTSSupported()) {
                    <button class="speak-btn" 
                            (click)="speakMessage(msg.text)" 
                            [title]="isSpeaking() ? 'Stop speaking' : 'Read aloud'">
                        <i class="bi" [ngClass]="isSpeaking() ? 'bi-stop-fill' : 'bi-volume-up'"></i>
                    </button>
                    }
                </div>
            </div>
        </div>
        }

        @if (isLoading()) {
        <div class="typing-indicator">
            <div class="typing-avatar">
                <img src="assets/images/kamen-rider-gotchard.jpg" alt="Bonzi">
            </div>
            <div class="typing-bubble">
                <div class="typing-dots">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <span class="typing-text">{{ loadingWord() }}</span>
            </div>
        </div>
        }

        @if (lastError()) {
        <div class="error-actions">
            <button class="retry-btn" (click)="retryLastMessage()">
                <i class="bi bi-arrow-clockwise"></i>
                Retry
            </button>
        </div>
        }

        @if (messages().length <= 1 && !isLoading()) {
        <div class="quick-actions">
            <p class="quick-actions-title">Quick Actions:</p>
            <div class="quick-actions-grid">
                @for (action of quickActions; track action.text) {
                <button class="quick-action-chip" (click)="sendQuickAction(action.prompt)">
                    <i class="bi" [class]="action.icon"></i>
                    <span>{{ action.text }}</span>
                </button>
                }
            </div>
        </div>
        }
    </div>

    <div class="input-area">
        @if (speechError()) {
        <div class="speech-error">
            <i class="bi bi-exclamation-circle"></i>
            <span>{{ speechError() }}</span>
        </div>
        }
        
        @if (isRecording() && liveTranscript()) {
        <div class="live-transcript">
            <i class="bi bi-mic-fill recording-icon"></i>
            <span>{{ liveTranscript() }}</span>
        </div>
        }
        
        <div class="input-row">
            <textarea [ngModel]="userInput()" (ngModelChange)="userInput.set($event)" (keydown)="handleKeydown($event)"
                [placeholder]="isRecording() ? 'Listening... Click mic to stop' : 'Type a message...'" rows="2" maxlength="1000"></textarea>
            
            @if (isSTTSupported()) {
            <button class="mic-btn" 
                    (click)="toggleRecording()" 
                    [class.recording]="isRecording()"
                    [title]="isRecording() ? 'Stop recording' : 'Voice input'"
                    [disabled]="isLoading()">
                <i class="bi" [ngClass]="isRecording() ? 'bi-mic-fill' : 'bi-mic'"></i>
            </button>
            }
            
            <button class="send-btn" (click)="sendMessage()" [disabled]="!userInput().trim() || isLoading()">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>