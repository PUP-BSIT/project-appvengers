
<div class="chatbot-sidebar" [class.open]="isOpen()">
    <div class="chatbot-header">
        <div class="header-content">
            <img src="assets/images/kamen-rider-gotchard.jpg" alt="Bonzi" class="header-avatar">
            <h3>Bonzi Buddy Chat</h3>
        </div>
        <div class="header-actions">
            <button class="icon-btn" (click)="clearChat()" title="Clear chat history">
                <i class="bi bi-trash"></i>
            </button>
            <button class="close-btn" (click)="toggleSidebar()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    <div class="messages-container" #scrollContainer>
        @if (messages().length === 0) {
        <div class="empty-state">
            <i class="bi bi-stars"></i>
            <p>How can I help you today?</p>
        </div>
        }

        @for (msg of messages(); track msg.timestamp) {
        <div class="message-wrapper" [class.user]="msg.isUser" [class.bot]="!msg.isUser">
            @if (!msg.isUser) {
            <div class="bot-avatar">
                <img src="assets/images/kamen-rider-gotchard.jpg" alt="Bonzi">
            </div>
            }
            <div class="message" [class.user]="msg.isUser" [class.bot]="!msg.isUser">
                <div class="message-content" [innerHTML]="parseMarkdown(msg.text)"></div>
                
                @if (msg.action && !msg.isUser) {
                <div class="message-action">
                    <button class="action-btn" (click)="executeAction(msg.action)">
                        <i class="bi" [ngClass]="msg.action.icon || 'bi-arrow-right-circle'"></i>
                        <span>{{ msg.action.label || 'Take action' }}</span>
                        <i class="bi bi-chevron-right action-arrow"></i>
                    </button>
                </div>
                }
                
                <div class="message-time">
                    {{ msg.timestamp | date:'shortTime' }}
                </div>
            </div>
        </div>
        }

        @if (isLoading()) {
        <div class="typing-indicator">
            <div class="typing-avatar">
                <img src="assets/images/kamen-rider-gotchard.jpg" alt="Bonzi">
            </div>
            <div class="typing-bubble">
                <div class="typing-dots">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
                <span class="typing-text">{{ loadingWord() }}</span>
            </div>
        </div>
        }

        @if (lastError()) {
        <div class="error-actions">
            <button class="retry-btn" (click)="retryLastMessage()">
                <i class="bi bi-arrow-clockwise"></i>
                Retry
            </button>
        </div>
        }

        @if (messages().length <= 1 && !isLoading()) {
        <div class="quick-actions">
            <p class="quick-actions-title">Quick Actions:</p>
            <div class="quick-actions-grid">
                @for (action of quickActions; track action.text) {
                <button class="quick-action-chip" (click)="sendQuickAction(action.prompt)">
                    <i class="bi" [class]="action.icon"></i>
                    <span>{{ action.text }}</span>
                </button>
                }
            </div>
        </div>
        }
    </div>

    <div class="input-area">
        <textarea [ngModel]="userInput()" (ngModelChange)="userInput.set($event)" (keydown)="handleKeydown($event)"
            placeholder="Type a message..." rows="1" maxlength="1000"></textarea>
        <button class="send-btn" (click)="sendMessage()" [disabled]="!userInput().trim() || isLoading()">
            <i class="bi bi-send-fill"></i>
        </button>
    </div>
</div>