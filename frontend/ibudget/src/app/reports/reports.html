<app-toggleable-sidebar></app-toggleable-sidebar>
<app-header></app-header>

<main class="reports-container container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
    <h1 class="h3 mb-0 text-gray-800">Financial Reports</h1>
    <button 
      class="btn btn-primary shadow-sm" 
      (click)="exportToPdf()" 
      [disabled]="isLoading()">
      <i class="fas fa-download me-2"></i> Export PDF
    </button>
  </div>

  <div class="tabs-container">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button 
          class="nav-link" 
          [class.active]="activeTab === 'lastMonth'"
          (click)="activeTab = 'lastMonth'"
          type="button" 
          role="tab">
          <i class="fas fa-calendar-alt me-2"></i>
          Last Month
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button 
          class="nav-link" 
          [class.active]="activeTab === 'thisMonth'"
          (click)="activeTab = 'thisMonth'"
          type="button" 
          role="tab">
          <i class="fas fa-calendar-alt me-2"></i>
          This Month
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Placeholder skeleton for loading state -->
      @if(isLoading()) {
        <div class="reports-container-skeleton">
          <div class="reports-grid">
            <div class="report-card skeleton">
              <div class="report-card-icon skeleton-circle"></div>
              <div class="report-card-content">
                <div class="skeleton-line short"></div>
                <div class="skeleton-line long"></div>
              </div>
            </div>

            <div class="report-card skeleton">
              <div class="report-card-icon skeleton-circle"></div>
              <div class="report-card-content">
                <div class="skeleton-line short"></div>
                <div class="skeleton-line long"></div>
              </div>
            </div>

            <div class="report-card skeleton">
              <div class="report-card-icon skeleton-circle"></div>
              <div class="report-card-content">
                <div class="skeleton-line short"></div>
                <div class="skeleton-line long"></div>
              </div>
            </div>
          </div>

          <div class="charts-section">
            <div class="chart-card">
              <div class="chart-title"><div class="skeleton-line short"></div></div>
              <div class="chart-wrapper">
                <div class="skeleton-chart"></div>
              </div>
            </div>

            <div class="chart-card">
              <div class="chart-title"><div class="skeleton-line short"></div></div>
              <div class="chart-wrapper">
                <div class="skeleton-chart"></div>
              </div>
            </div>
          </div>
        </div>
      } @else if (thisMonthReport && lastMonthReport) {
        <div class="overall-computation">
          <h2 class="overall-title">
            <i class="fas fa-chart-line me-2"></i>
            Overall Financial Summary
          </h2>
          
          <div class="comparison-grid">
            <div class="comparison-card">
              <div class="comparison-header">
                <i class="fas fa-coins"></i>
                <span>Total Income</span>
              </div>
              <div class="comparison-body">
                <div class="comparison-item">
                  <span class="month-label">Last Month</span>
                  <span class="amount income">
                    ₱{{ lastMonthReport.totalIncome | number:'1.2-2' }}
                  </span>
                </div>
                <div class="comparison-item">
                  <span class="month-label">This Month</span>
                  <span class="amount income">
                    ₱{{ thisMonthReport.totalIncome | number:'1.2-2' }}
                  </span>
                </div>
                <div class="comparison-total">
                  <span class="total-label">Total</span>
                  <span class="total-amount">
                    ₱{{ (lastMonthReport.totalIncome + 
                          thisMonthReport.totalIncome) | number:'1.2-2' }}
                    </span>
                </div>
              </div>
            </div>
            <div class="comparison-card">
              <div class="comparison-header">
                <i class="fas fa-shopping-cart"></i>
                <span>Total Expenses</span>
              </div>
              <div class="comparison-body">
                <div class="comparison-item">
                  <span class="month-label">Last Month</span>
                  <span class="amount expense">
                    ₱{{ lastMonthReport.totalSpent | number:'1.2-2' }}
                  </span>
                </div>
                <div class="comparison-item">
                  <span class="month-label">This Month</span>
                  <span class="amount expense">
                    ₱{{ thisMonthReport.totalSpent | number:'1.2-2' }}
                  </span>
                </div>
                <div class="comparison-total">
                  <span class="total-label">Total</span>
                  <span class="total-amount">
                    ₱{{ (lastMonthReport.totalSpent + 
                         thisMonthReport.totalSpent) | number:'1.2-2' }}
                  </span>
                </div>
              </div>
            </div>

            <div class="comparison-card highlight">
              <div class="comparison-header">
                <i class="fas fa-wallet"></i>
                <span>Net Balance</span>
              </div>
              <div class="comparison-body">
                <div class="comparison-item">
                  <span class="month-label">Last Month</span>
                  <span class="amount" 
                    [class.positive]="lastMonthReport.totalIncome -
                                      lastMonthReport.totalSpent > 0"
                    [class.negative]="lastMonthReport.totalIncome -
                                        lastMonthReport.totalSpent < 0">
                    ₱{{ (lastMonthReport.totalIncome -
                          lastMonthReport.totalSpent) | number:'1.2-2' }}
                  </span>
                </div>
                <div class="comparison-item">
                  <span class="month-label">This Month</span>
                  <span class="amount" 
                    [class.positive]="thisMonthReport.totalIncome -
                                      thisMonthReport.totalSpent > 0"
                    [class.negative]="thisMonthReport.totalIncome -
                                      thisMonthReport.totalSpent < 0">
                    ₱{{ (thisMonthReport.totalIncome -
                         thisMonthReport.totalSpent) | number:'1.2-2' }}
                  </span>
                </div>
                <div class="comparison-total">
                  <span class="total-label">Overall</span>
                  <span class="total-amount" 
                    [class.positive]="(lastMonthReport.totalIncome +
                                       thisMonthReport.totalIncome) -
                      (lastMonthReport.totalSpent +
                       thisMonthReport.totalSpent) > 0"
                    [class.negative]="(lastMonthReport.totalIncome +
                                       thisMonthReport.totalIncome) -
                      (lastMonthReport.totalSpent +
                       thisMonthReport.totalSpent) < 0">
                    ₱{{ ((lastMonthReport.totalIncome +
                          thisMonthReport.totalIncome) -
                            (lastMonthReport.totalSpent +
                            thisMonthReport.totalSpent)) | number:'1.2-2' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      }

      @if (activeTab === 'lastMonth' && lastMonthReport) {
        <div class="tab-pane active">
          <div class="report-header-title">
            <i class="fas fa-calendar-alt"></i>
            Last Month ({{ lastMonthReport.monthName }})
          </div>

          <div class="charts-section">
            <div class="chart-card">
              <h3 class="chart-title">
                <i class="fas fa-arrow-up me-2"></i>
                Income by Category
              </h3>
              <div class="chart-wrapper">
                @if (!lastMonthIncomeChartData ||
                     !lastMonthIncomeChartData.datasets ||
                     !lastMonthIncomeChartData.datasets.length ||
                     !lastMonthIncomeChartData.datasets[0].data ||
                     !lastMonthIncomeChartData.datasets[0].data.length) {
                  <div class="empty-chart-state">
                    <i 
                      class="bi bi-graph-up-arrow"
                      style="font-size:3rem;color:#ff6f61;"></i>
                    <div
                      class="empty-chart-label text-primary fw-bold mt-2"
                      style="font-size:1.2rem;">
                        NO INCOME YET
                    </div>
                  </div>
                } @else {
                  <canvas baseChart
                    [data]="lastMonthIncomeChartData"
                    [type]="chartType"
                    [options]="chartOptions">
                  </canvas>
                }
              </div>
            </div>

            <div class="chart-card">
              <h3 class="chart-title">
                <i class="fas fa-arrow-down me-2"></i>
                Expenses by Category
              </h3>
              <div class="chart-wrapper">
                @if (!lastMonthExpenseChartData ||
                     !lastMonthExpenseChartData.datasets ||
                     !lastMonthExpenseChartData.datasets.length ||
                     !lastMonthExpenseChartData.datasets[0].data ||
                     !lastMonthExpenseChartData.datasets[0].data.length) {
                  <div class="empty-chart-state">
                    <i
                      class="bi bi-graph-down-arrow"
                      style="font-size:3rem;color:#ff6f61;"></i>
                    <div
                      class="empty-chart-label text-primary fw-bold mt-2"
                      style="font-size:1.2rem;">
                        NO EXPENSES YET
                    </div>
                  </div>
                } @else {
                  <canvas baseChart
                    [data]="lastMonthExpenseChartData"
                    [type]="chartType"
                    [options]="chartOptions">
                  </canvas>
                }
              </div>
            </div>
          </div>

          <!-- Bar Section for Last Month -->
          <div class="chart-card bar-chart-card">
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="chart-title">
                <i class="fas fa-chart-bar me-2"></i>
                {{ barMode() === 'expense' ? 'Expense Breakdown' : 
                  'Income Breakdown' }}
              </h3>

              <!-- Arrow Toggle -->
              <button class="btn btn-outline-secondary btn-sm" 
                (click)="toggleBarMode()">
                {{ barMode() === 'expense' ? 'Show Income →' : 
                  'Show Expenses →' }}
              </button>
            </div>

            <div class="chart-wrapper">
              @if (!lastMonthBarData().datasets[0].data.length) {
                <div class="empty-chart-state">
                  <i class="bi bi-bar-chart" 
                    style="font-size:3rem;color:#ff6f61;">
                  </i>
                  <div class="empty-chart-label text-primary fw-bold mt-2" 
                    style="font-size:1.2rem;">
                    {{ barMode() === 'expense' ? 'NO EXPENSES YET' : 
                      'NO INCOME YET' }}
                  </div>
                </div>
              } @else {
                <canvas baseChart
                  [data]="lastMonthBarData()"
                  [type]="'bar'"
                  [options]="barChartOptions">
                </canvas>
              }
            </div>
          </div>
        </div>
      }

      @if (activeTab === 'thisMonth' && thisMonthReport) {
        <div class="tab-pane active">
          <div class="report-header-title">
            <i class="fas fa-calendar-alt"></i>
            This Month ({{ thisMonthReport.monthName }})
          </div>

          <div class="charts-section">
            <div class="chart-card">
              <h3 class="chart-title">
                <i class="fas fa-arrow-up me-2"></i>
                Income by Category
              </h3>
              <div class="chart-wrapper">
                @if (!thisMonthIncomeChartData ||
                     !thisMonthIncomeChartData.datasets ||
                     !thisMonthIncomeChartData.datasets.length ||
                     !thisMonthIncomeChartData.datasets[0].data ||
                     !thisMonthIncomeChartData.datasets[0].data.length) {
                  <div class="empty-chart-state">
                    <i
                      class="bi bi-graph-up-arrow"
                      style="font-size:3rem;color:#ff6f61;"></i>
                    <div
                      class="empty-chart-label text-primary fw-bold mt-2"
                      style="font-size:1.2rem;">
                        NO INCOME YET
                    </div>
                  </div>
                } @else {
                  <canvas baseChart
                    [data]="thisMonthIncomeChartData"
                    [type]="chartType"
                    [options]="chartOptions">
                  </canvas>
                }
              </div>
            </div>

            <div class="chart-card">
              <h3 class="chart-title">
                <i class="fas fa-arrow-down me-2"></i>
                Expenses by Category
              </h3>
              <div class="chart-wrapper">
                @if (!thisMonthExpenseChartData ||
                     !thisMonthExpenseChartData.datasets ||
                     !thisMonthExpenseChartData.datasets.length ||
                     !thisMonthExpenseChartData.datasets[0].data ||
                     !thisMonthExpenseChartData.datasets[0].data.length) {
                  <div class="empty-chart-state">
                    <i
                      class="bi bi-graph-down-arrow"
                      style="font-size:3rem;color:#ff6f61;"></i>
                    <div
                      class="empty-chart-label text-primary fw-bold mt-2"
                      style="font-size:1.2rem;">
                      NO EXPENSES YET
                    </div>
                  </div>
                } @else {
                  <canvas baseChart
                    [data]="thisMonthExpenseChartData"
                    [type]="chartType"
                    [options]="chartOptions">
                  </canvas>
                }
              </div>
            </div>
          </div>

          <!-- Bar Section for This Month -->
          <div class="chart-card bar-chart-card">
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="chart-title">
                <i class="fas fa-chart-bar me-2"></i>
                {{ barMode() === 'expense' ? 'Expense Breakdown' : 
                  'Income Breakdown' }}
              </h3>

              <!-- Arrow Toggle -->
              <button 
                class="btn btn-outline-secondary btn-sm" 
                (click)="toggleBarMode()">
                {{ barMode() === 'expense' ? 'Show Income →' : 
                  'Show Expenses →' }}
              </button>
            </div>

            <div class="chart-wrapper">
              @if (!thisMonthBarData().datasets[0]?.data?.length) {
                <div class="empty-chart-state">
                  <i class="bi bi-bar-chart" 
                    style="font-size:3rem;color:#ff6f61;">
                  </i>
                  <div class="empty-chart-label text-primary fw-bold mt-2" 
                    style="font-size:1.2rem;">
                    {{ barMode() === 'expense' ? 'NO EXPENSES YET' : 
                      'NO INCOME YET' }}
                  </div>
                </div>
              } @else {
                <canvas baseChart
                  [data]="thisMonthBarData()"
                  [type]="'bar'"
                  [options]="barChartOptions">
                </canvas>
              }
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</main>
