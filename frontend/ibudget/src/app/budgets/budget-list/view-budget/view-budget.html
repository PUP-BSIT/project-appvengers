<app-toggleable-sidebar/>
<app-header/>

<main>
  <!-- Key Performance Indicator Panel -->
  <app-kpi-panel/>

  <!-- Budgets Transactions Goes Here -->
  <div class="expenses-history-container">
    <div class="title-actions-container">      
      <div>
        <h4>Expenses History</h4>
      </div>

      <div>
        <app-add-budget-expense
        [categories]="categories()"
        [disabled]="isBudgetExceeded()"
        (addBudgetExpenseResponse)="onBudgetExpenseAdded($event)"/>
      </div>
    </div>

    <div class="expenses-table-container">
      <table class="table table-striped">
        <thead class="table-dark">
          <tr>
            <th scope="col">Date</th>
            <th scope="col">Description</th>
            <th scope="col">Category</th>
            <th scope="col">Amount</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Placeholder while loading -->
          @if(isLoading()) {
            <tr>
              <td colspan="5" class="text-center">
                <span class="placeholder col-12 placeholder-style"></span>
              </td>
            </tr>
            <tr>
              <td colspan="5" class="text-center">
                <span class="placeholder col-12 placeholder-style"></span>
              </td>
            </tr>
          } @else if(budgetExpenses().length === 0) {
            <tr>
              <td colspan="5" class="text-center">
                No budget expenses found.
              </td>
            </tr>
          } @else {
            @for(transaction of budgetExpenses(); track $index) {
              <tr>
                <td>{{ transaction.transactionDate }}</td>
                <td>{{ transaction.description }}</td>
                <td>{{ getCategoryName(transaction.categoryId) }}</td>
                <td class="text-danger fw-bold">
                  - &#8369; {{ transaction.amount }}
                </td>
                <td>
                  <button 
                    class="btn btn-sm btn-warning me-2"
                    (click)="openUpdateModal(transaction.transactionId)">
                      <i class="bi bi-pencil"></i>
                  </button>

                  <button 
                    class="btn btn-sm btn-danger" 
                    (click)="deleteBudgetExpense(transaction.transactionId)">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    <!-- Appears only on mobile devices -->
    <div class="expenses-list">
      <ol class="d-flex flex-column justify-content-center list-unstyled">
        @for(transaction of budgetExpenses(); track $index) {
          <li 
            class="card p-3 d-flex justify-content-between 
            flex-column align-items-center mb-3">
            <div class="d-flex flex-row justify-content-between 
              w-100 align-items-center mb-2">
              <div class="mb-0">
                <span>{{ $index + 1 }}. </span>
                <strong>{{ transaction.transactionDate }}</strong>
              </div>

              <!-- Kebab Icon -->
              <div class="kebab-menu">
                <i 
                  class="fas fa-ellipsis-v"
                  (click)="toggleDropdown($index)"></i>

                <div class="kebab-dropdown" [class.hide]="isDropdownOpen() !== $index">
                  <button 
                    class="btn text-black me-2"
                    (click)="openUpdateModal(transaction.transactionId)">
                    Edit
                  </button>

                  <button 
                    class="btn text-danger" 
                    (click)="deleteBudgetExpense(transaction.transactionId)">
                    Delete
                  </button>
                </div>
              </div>
            </div>

            <div class="d-flex flex-row justify-content-between w-100
              align-items-center">
              <div class="text-muted mb-0"> 
                {{ getCategoryName(transaction.categoryId) }}
              </div>

              <div class="text-danger fw-bold mb-0 align-bottom h-100">
               - &#8369; {{ transaction.amount }}
              </div>
            </div>
          </li>
        }
      </ol>
    </div>
  </div>
</main>

<app-update-budget-expense
  #updateBudgetModal
  [categories] ="categories()"
  (updateBudgetExpenseResponse)="onBudgetExpenseUpdated($event)"/>

<!-- Snackbar -->
@if (showNotification()) {
  <div class="snackbar" [class.hide]="isHidingNotification()">
    <i class="fas fa-check-circle"></i>
    <span>{{ notificationMessage() }}</span>
  </div>
}
