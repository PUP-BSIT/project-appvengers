import{a as c}from"./chunk-H4HKKKHV.js";import{p as W}from"./chunk-OQ6H4KVU.js";import{A as g,J as b,L as k,M as d,N as I,P as w,Ra as _,S as U,T as A,U as l,V as M,ba as P,c as R,f as S,jb as N,lb as O,n as h,v as p,w as y}from"./chunk-DFJZCQ6A.js";import{a as D}from"./chunk-DAQOROHW.js";var T="Service workers are disabled or not supported by this browser",f=class{serviceWorker;worker;registration;events;constructor(e,t){if(this.serviceWorker=e,!e)this.worker=this.events=this.registration=new R(s=>s.error(new d(5601,!1)));else{let s=null,r=new S;this.worker=new R(a=>(s!==null&&a.next(s),r.subscribe(E=>a.next(E))));let o=()=>{let{controller:a}=e;a!==null&&(s=a,r.next(s))};e.addEventListener("controllerchange",o),o(),this.registration=this.worker.pipe(b(()=>e.getRegistration().then(a=>{if(!a)throw new d(5601,!1);return a})));let i=new S;this.events=i.asObservable();let u=a=>{let{data:E}=a;E?.type&&i.next(E)};e.addEventListener("message",u),t?.get(O,null,{optional:!0})?.onDestroy(()=>{e.removeEventListener("controllerchange",o),e.removeEventListener("message",u)})}}postMessage(e,t){return new Promise(s=>{this.worker.pipe(g(1)).subscribe(r=>{r.postMessage(D({action:e},t)),s()})})}postMessageWithOperation(e,t,s){let r=this.waitForOperationCompleted(s),o=this.postMessage(e,t);return Promise.all([o,r]).then(([,i])=>i)}generateNonce(){return Math.round(Math.random()*1e7)}eventsOfType(e){let t;return typeof e=="string"?t=s=>s.type===e:t=s=>e.includes(s.type),this.events.pipe(y(t))}nextEventOfType(e){return this.eventsOfType(e).pipe(g(1))}waitForOperationCompleted(e){return new Promise((t,s)=>{this.eventsOfType("OPERATION_COMPLETED").pipe(y(r=>r.nonce===e),g(1),h(r=>{if(r.result!==void 0)return r.result;throw new Error(r.error)})).subscribe({next:t,error:s})})}get isEnabled(){return!!this.serviceWorker}},L=(()=>{class n{sw;messages;notificationClicks;notificationCloses;pushSubscriptionChanges;subscription;get isEnabled(){return this.sw.isEnabled}pushManager=null;subscriptionChanges=new S;constructor(t){if(this.sw=t,!t.isEnabled){this.messages=p,this.notificationClicks=p,this.notificationCloses=p,this.pushSubscriptionChanges=p,this.subscription=p;return}this.messages=this.sw.eventsOfType("PUSH").pipe(h(r=>r.data)),this.notificationClicks=this.sw.eventsOfType("NOTIFICATION_CLICK").pipe(h(r=>r.data)),this.notificationCloses=this.sw.eventsOfType("NOTIFICATION_CLOSE").pipe(h(r=>r.data)),this.pushSubscriptionChanges=this.sw.eventsOfType("PUSH_SUBSCRIPTION_CHANGE").pipe(h(r=>r.data)),this.pushManager=this.sw.registration.pipe(h(r=>r.pushManager));let s=this.pushManager.pipe(b(r=>r.getSubscription()));this.subscription=new R(r=>{let o=s.subscribe(r),i=this.subscriptionChanges.subscribe(r);return()=>{o.unsubscribe(),i.unsubscribe()}})}requestSubscription(t){if(!this.sw.isEnabled||this.pushManager===null)return Promise.reject(new Error(T));let s={userVisibleOnly:!0},r=this.decodeBase64(t.serverPublicKey.replace(/_/g,"/").replace(/-/g,"+")),o=new Uint8Array(new ArrayBuffer(r.length));for(let i=0;i<r.length;i++)o[i]=r.charCodeAt(i);return s.applicationServerKey=o,new Promise((i,u)=>{this.pushManager.pipe(b(v=>v.subscribe(s)),g(1)).subscribe({next:v=>{this.subscriptionChanges.next(v),i(v)},error:u})})}unsubscribe(){if(!this.sw.isEnabled)return Promise.reject(new Error(T));let t=s=>{if(s===null)throw new d(5602,!1);return s.unsubscribe().then(r=>{if(!r)throw new d(5603,!1);this.subscriptionChanges.next(null)})};return new Promise((s,r)=>{this.subscription.pipe(g(1),b(t)).subscribe({next:s,error:r})})}decodeBase64(t){return atob(t)}static \u0275fac=function(s){return new(s||n)(A(f))};static \u0275prov=w({token:n,factory:n.\u0275fac})}return n})(),C=(()=>{class n{sw;versionUpdates;unrecoverable;get isEnabled(){return this.sw.isEnabled}ongoingCheckForUpdate=null;constructor(t){if(this.sw=t,!t.isEnabled){this.versionUpdates=p,this.unrecoverable=p;return}this.versionUpdates=this.sw.eventsOfType(["VERSION_DETECTED","VERSION_INSTALLATION_FAILED","VERSION_READY","NO_NEW_VERSION_DETECTED"]),this.unrecoverable=this.sw.eventsOfType("UNRECOVERABLE_STATE")}checkForUpdate(){if(!this.sw.isEnabled)return Promise.reject(new Error(T));if(this.ongoingCheckForUpdate)return this.ongoingCheckForUpdate;let t=this.sw.generateNonce();return this.ongoingCheckForUpdate=this.sw.postMessageWithOperation("CHECK_FOR_UPDATES",{nonce:t},t).finally(()=>{this.ongoingCheckForUpdate=null}),this.ongoingCheckForUpdate}activateUpdate(){if(!this.sw.isEnabled)return Promise.reject(new d(5601,!1));let t=this.sw.generateNonce();return this.sw.postMessageWithOperation("ACTIVATE_UPDATE",{nonce:t},t)}static \u0275fac=function(s){return new(s||n)(A(f))};static \u0275prov=w({token:n,factory:n.\u0275fac})}return n})();var j=new U("");function V(){let n=l(m);if(!("serviceWorker"in navigator&&n.enabled!==!1))return;let e=l(j),t=l(_),s=l(O);t.runOutsideAngular(()=>{let r=navigator.serviceWorker,o=()=>r.controller?.postMessage({action:"INITIALIZE"});r.addEventListener("controllerchange",o),s.onDestroy(()=>{r.removeEventListener("controllerchange",o)})}),t.runOutsideAngular(()=>{let r,{registrationStrategy:o}=n;if(typeof o=="function")r=new Promise(i=>o().subscribe(()=>i()));else{let[i,...u]=(o||"registerWhenStable:30000").split(":");switch(i){case"registerImmediately":r=Promise.resolve();break;case"registerWithDelay":r=F(+u[0]||0);break;case"registerWhenStable":r=Promise.race([s.whenStable(),F(+u[0])]);break;default:throw new d(5600,!1)}}r.then(()=>{s.destroyed||navigator.serviceWorker.register(e,{scope:n.scope,updateViaCache:n.updateViaCache,type:n.type}).catch(i=>console.error(I(5604,!1)))})})}function F(n){return new Promise(e=>setTimeout(e,n))}function x(n,e){return new f(n.enabled!==!1?navigator.serviceWorker:void 0,e)}var m=class{enabled;updateViaCache;type;scope;registrationStrategy};function J(n,e={}){return M([L,C,{provide:j,useValue:n},{provide:m,useValue:e},{provide:f,useFactory:x,deps:[m,P]},N(V)])}var $=class n{apiUrl=`${c.apiUrl}/auth`;http=l(W);swUpdate=l(C,{optional:!0});signup(e){return this.http.post(`${this.apiUrl}/signup`,e)}checkUsername(e){return this.http.get(`
      ${this.apiUrl}/check-username/${e}
    `)}checkEmail(e){return this.http.get(`${this.apiUrl}/check-email/${e}`)}verifyEmail(e){return this.http.get(`
      ${this.apiUrl}/verify-email?token=${e}
    `)}login(e){return this.http.post(`${this.apiUrl}/login`,e).pipe(k(t=>{t.success&&t.data?.token&&(localStorage.setItem("iBudget_authToken",t.data.token),t.data.username&&localStorage.setItem("iBudget_username",t.data.username))}))}async logout(){localStorage.removeItem("iBudget_authToken"),localStorage.removeItem("iBudget_username"),Object.keys(localStorage).forEach(e=>{(e.startsWith("iBudget_")||e.startsWith("chatbot_"))&&localStorage.removeItem(e)}),sessionStorage.clear(),await this.clearServiceWorkerCache(),c.production||console.log("\u{1F6AA} User logged out - all storage and caches cleared")}async clearServiceWorkerCache(){if(!this.swUpdate||!this.swUpdate.isEnabled){c.production||console.log("\u26A0\uFE0F Service Worker not available or not enabled, skipping cache clear");return}try{let e=await caches.keys();c.production||console.log(`\u{1F5D1}\uFE0F Clearing ${e.length} Service Worker caches...`),await Promise.all(e.map(t=>(c.production||console.log(`  \u21B3 Deleting cache: ${t}`),caches.delete(t)))),c.production||console.log("\u2705 Service Worker caches cleared successfully")}catch(e){console.error("\u26A0\uFE0F Failed to clear Service Worker cache:",e),console.warn("User should manually clear browser cache if issues persist")}}getToken(){return localStorage.getItem("iBudget_authToken")}isLoggedIn(){return!!this.getToken()}getProfile(){let e=this.getToken();return this.http.get(`${c.apiUrl}/user/profile`,{headers:{Authorization:`Bearer ${e}`}})}forgotPassword(e){return this.http.post(`${this.apiUrl}/forgot-password`,e)}validateResetToken(e){return this.http.get(`
      ${this.apiUrl}/validate-reset-token?token=${e}
    `)}resetPassword(e){return this.http.post(`${this.apiUrl}/reset-password`,e)}changePassword(e){return this.http.post(`${this.apiUrl}/change-password`,e)}reactivateAccount(e){return this.http.post(`${this.apiUrl}/reactivate`,e).pipe(k(t=>{t.success&&t.data?.token&&localStorage.setItem("iBudget_authToken",t.data.token)}))}handleOAuthCallback(e,t){localStorage.setItem("iBudget_authToken",e),t&&localStorage.setItem("iBudget_username",t),c.production||console.log("OAuth token stored successfully")}getGoogleOAuthUrl(){return c.oauth2GoogleUrl}static \u0275fac=function(t){return new(t||n)};static \u0275prov=w({token:n,factory:n.\u0275fac,providedIn:"root"})};export{C as a,J as b,$ as c};
