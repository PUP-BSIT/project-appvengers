import{a as s}from"./chunk-H4HKKKHV.js";import{p as h}from"./chunk-OQ6H4KVU.js";import{P as a,U as S,g as d,ha as g}from"./chunk-DFJZCQ6A.js";import{a as c,b as l}from"./chunk-DAQOROHW.js";var m=class i{toastsSubject=new d([]);toasts$=this.toastsSubject.asObservable();idCounter=0;show(e){let t=++this.idCounter,r=l(c({},e),{id:t});this.toastsSubject.next([...this.toastsSubject.value,r]);let o=e.duration??5e3;return o>0&&setTimeout(()=>this.dismiss(t),o),t}dismiss(e){let t=this.toastsSubject.value.filter(r=>r.id!==e);this.toastsSubject.next(t)}dismissAll(){this.toastsSubject.next([])}info(e,t,r){return this.show({title:e,message:t,type:"info",icon:"fas fa-info-circle",action:r})}success(e,t,r){return this.show({title:e,message:t,type:"success",icon:"fas fa-check-circle",action:r})}warning(e,t,r){return this.show({title:e,message:t,type:"warning",icon:"fas fa-exclamation-triangle",action:r})}error(e,t,r){return this.show({title:e,message:t,type:"error",icon:"fas fa-times-circle",action:r})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})};var u=class i{userIdSignal=g(null);setUserId(e){this.userIdSignal.set(e),s.production||console.log(`[LocalStorageService] User context set: ${e}`)}getUserId(){return this.userIdSignal()}clearUserId(){this.userIdSignal.set(null),s.production||console.log("[LocalStorageService] User context cleared")}setItem(e,t){let r=this.userIdSignal();if(r===null)throw console.error(`[LocalStorageService] Cannot set '${e}' - no userId set. Call setUserId() first.`),new Error("LocalStorageService: userId not set");let o=`user_${r}_${e}`;try{localStorage.setItem(o,JSON.stringify(t)),s.production||console.log(`[LocalStorageService] Stored: ${o}`)}catch(n){throw console.error(`[LocalStorageService] Failed to store ${o}:`,n),n}}getItem(e){let t=this.userIdSignal();if(t===null)return console.error(`[LocalStorageService] Cannot get '${e}' - no userId set. Call setUserId() first.`),null;let r=`user_${t}_${e}`;try{let o=localStorage.getItem(r);return o===null?(s.production||console.log(`[LocalStorageService] Key not found: ${r}`),null):JSON.parse(o)}catch(o){return console.error(`[LocalStorageService] Failed to parse ${r}:`,o),null}}removeItem(e){let t=this.userIdSignal();if(t===null){console.error(`[LocalStorageService] Cannot remove '${e}' - no userId set.`);return}let r=`user_${t}_${e}`;localStorage.removeItem(r),s.production||console.log(`[LocalStorageService] Removed: ${r}`)}clearUserData(){let e=this.userIdSignal();if(e===null){console.warn("[LocalStorageService] clearUserData called but no userId set");return}let t=`user_${e}_`,r=[];for(let o=0;o<localStorage.length;o++){let n=localStorage.key(o);n&&n.startsWith(t)&&r.push(n)}r.forEach(o=>{localStorage.removeItem(o),s.production||console.log(`[LocalStorageService] Cleared user data: ${o}`)}),s.production||console.log(`[LocalStorageService] Cleared ${r.length} items for user ${e}`)}setGlobalItem(e,t){let r=`app_${e}`;try{localStorage.setItem(r,JSON.stringify(t)),s.production||console.log(`[LocalStorageService] Stored global: ${r}`)}catch(o){throw console.error(`[LocalStorageService] Failed to store global ${r}:`,o),o}}getGlobalItem(e){let t=`app_${e}`;try{let r=localStorage.getItem(t);return r===null?null:JSON.parse(r)}catch(r){return console.error(`[LocalStorageService] Failed to parse global ${t}:`,r),null}}removeGlobalItem(e){let t=`app_${e}`;localStorage.removeItem(t),s.production||console.log(`[LocalStorageService] Removed global: ${t}`)}hasItem(e){let t=this.userIdSignal();if(t===null)return!1;let r=`user_${t}_${e}`;return localStorage.getItem(r)!==null}getUserKeys(){let e=this.userIdSignal();if(e===null)return[];let t=`user_${e}_`,r=[];for(let o=0;o<localStorage.length;o++){let n=localStorage.key(o);n&&n.startsWith(t)&&r.push(n.replace(t,""))}return r}static \u0275fac=function(t){return new(t||i)};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})};var A={MAX_MESSAGE_LENGTH:500,MIN_MESSAGE_LENGTH:1},v=class i{http=S(h);localStorageService=S(u);apiUrl=`${s.apiUrl}/chatbot/message`;SESSION_STORAGE_KEY="bonzi_session_id";MESSAGES_STORAGE_KEY="bonzi_chat_history";_sessionId=null;isOpen=g(!1);stateVersion=g(0);get sessionId(){try{let e=this.localStorageService.getItem(this.SESSION_STORAGE_KEY);if(e)return e}catch{}return this._sessionId||(this._sessionId=this.generateSessionId(),this.saveSessionId(this._sessionId)),this._sessionId}sendMessage(e){return this.http.post(this.apiUrl,{message:e,sessionId:this.sessionId})}toggle(){this.isOpen.update(e=>!e)}loadOrGenerateSessionId(){try{let t=this.localStorageService.getItem(this.SESSION_STORAGE_KEY);if(t)return t}catch(t){console.warn("[ChatbotService] Failed to load session ID:",t)}let e=this.generateSessionId();return this.saveSessionId(e),e}saveSessionId(e){try{this.localStorageService.setItem(this.SESSION_STORAGE_KEY,e)}catch(t){console.warn("[ChatbotService] Failed to save session ID:",t)}}generateSessionId(){let e=Date.now().toString(36),t=Math.random().toString(36).substring(2,10);return`chat-${e}-${t}`}getSessionId(){return this.sessionId}saveMessages(e){try{let t=e.map(r=>l(c({},r),{timestamp:r.timestamp.toISOString()}));this.localStorageService.setItem(this.MESSAGES_STORAGE_KEY,t)}catch(t){console.warn("[ChatbotService] Failed to save messages:",t)}}loadMessages(){try{let e=this.localStorageService.getItem(this.MESSAGES_STORAGE_KEY);if(e)return e.map(t=>l(c({},t),{timestamp:new Date(t.timestamp)}))}catch(e){console.warn("[ChatbotService] Failed to load messages:",e)}return[]}clearHistory(){try{this.localStorageService.removeItem(this.MESSAGES_STORAGE_KEY),this.localStorageService.removeItem(this.SESSION_STORAGE_KEY),s.production||console.log("[ChatbotService] Chat history cleared")}catch(e){console.warn("[ChatbotService] Failed to clear chat history:",e)}}clearState(){s.production||console.log("[ChatbotService] Clearing chatbot state"),this._sessionId=null,this.isOpen.set(!1),this.stateVersion.update(e=>e+1)}static \u0275fac=function(t){return new(t||i)};static \u0275prov=a({token:i,factory:i.\u0275fac,providedIn:"root"})};export{m as a,u as b,A as c,v as d};
